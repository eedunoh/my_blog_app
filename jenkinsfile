pipeline {
  agent any

  environment {
    DOCKERHUB_CREDENTIALS = credentials('my_docker_hub_secrets')   // Jenkins credential ID for Docker Hub login
    IMAGE_NAME = 'jackedu/blog_app_repo'
    IMAGE_TAG = 'latest'
  }

  stages {

    stage('Checkout Code') {
      steps {
        echo 'Checking out the repository...'
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        echo 'Building Docker image...'
        dir('app_folder') {
          script {
            dockerImage = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
          }
        }
      }
    }

    stage('Push to Docker Hub') {
      steps {
        echo 'Pushing image to Docker Hub...'
        script {
          docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS) {
            dockerImage.push("${IMAGE_TAG}")
          }
        }
      }
    }

    stage('Terraform Init & Apply') {
      environment {
        AWS_CREDS = credentials('my_aws_credentials')    // Jenkins credentials binding
        AWS_DEFAULT_REGION = 'eu-north-1'
      }

      steps {
        dir('terraform_folder') {
          echo 'Initializing Terraform...'

          sh '''
            export AWS_ACCESS_KEY_ID=$AWS_CREDS_USR
            export AWS_SECRET_ACCESS_KEY=$AWS_CREDS_PSW

            terraform init
            terraform plan
            terraform apply -auto-approve
          '''
        }
      }
    }
  }

  post {
    success {
      echo '✅ Pipeline completed successfully!'
    }
    failure {
      echo '❌ Pipeline failed!'
    }
  }
}
